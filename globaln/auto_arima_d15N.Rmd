---
title: "Time series forecasting with d15N data"
author: "Quentin D. Read"
date: "1/4/2021"
output: pdf_document
---

Load the data.

```{r, message = FALSE}
library(tidyverse)
library(forecast)

foliar15N <- read_csv('foliar_15N.csv')
lake15N <- read_csv('lake_15N.csv')
wood15N <- read_csv('wood_15N.csv')
```

Average measurements by year. Include a number of measurements for weighting if needed. Rename column.

```{r, message = FALSE}
avg_fn <- function(dat, mean_name, n_name) {
  dat %>%
    group_by(Year) %>%
    summarize(!!n_name := length(d15N),
              !!mean_name := mean(d15N))
}

foliar_byyear <- foliar15N %>% avg_fn('foliar_d15N', 'foliar_n_obs')
lake_byyear <- lake15N %>% avg_fn('lake_d15N', 'lake_n_obs')
wood_byyear <- wood15N %>% avg_fn('wood_d15N', 'wood_n_obs')
```

Join data.

```{r}
d15N_all <- reduce(list(foliar_byyear, lake_byyear, wood_byyear), full_join, by = 'Year') %>%
  arrange(Year)
```

Convert data to time series.

```{r}
d15N_timeseries <- ts(d15N_all[, c('foliar_d15N', 'lake_d15N', 'wood_d15N')])
```

Use `auto.arima()` to find the optimal ARIMA parameters predicting foliar d15N from lake and wood d15N separately; also tried lake and wood d15N together. ARIMA means autoregressive integrated moving-average model. We are testing out different values for the first parameter AR which is the lag, and the third parameter MA which is the order of the moving average model.

```{r}
auto.arima(y = d15N_timeseries[, 'foliar_d15N'], xreg = d15N_timeseries[, 'lake_d15N'], 
           ic = 'aicc', trace = TRUE, seasonal = FALSE, stepwise = FALSE, approximation = FALSE)
auto.arima(y = d15N_timeseries[, 'foliar_d15N'], xreg = d15N_timeseries[, 'wood_d15N'], 
           ic = 'aicc', trace = TRUE, seasonal = FALSE, stepwise = FALSE, approximation = FALSE)
auto.arima(y = d15N_timeseries[, 'foliar_d15N'], xreg = d15N_timeseries[, c('lake_d15N', 'wood_d15N')], 
           ic = 'aicc', trace = TRUE, seasonal = FALSE, stepwise = FALSE, approximation = FALSE)
```

Both of these select `ARIMA(0, 0, 0)` as the best model. The AR(1) process corresponds to `ARIMA(1, 0, 0)`. Basically from this I determine that there is no significant temporal autocorrelation. It tested out multiple lag periods as well. So perhaps we can just ignore it? This approach does not permit the use of the weights for uneven numbers of measurements per year "out of the box" but as before I think those are relatively unimportant.